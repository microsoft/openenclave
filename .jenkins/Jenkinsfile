@Library("OpenEnclaveCommon") _
oe = new jenkins.common.Openenclave()

GLOBAL_TIMEOUT_MINUTES = 240
CTEST_TIMEOUT_SECONDS = 480
GLOBAL_ERROR = null

def win2016CrossCompile(String build_type, String has_quote_provider = 'OFF', String lvi_mitigation = 'None', String OE_SIMULATION = "0") {
    def node_label = 'SGXFLC-Windows'
    if (has_quote_provider == "ON") {
        node_label = 'SGXFLC-Windows-DCAP'
    }
    stage("Windows ${build_type} with SGX ${has_quote_provider} LVI_MITIGATION=${lvi_mitigation}") {
        node(node_label) {
            withEnv(["OE_SIMULATION=${OE_SIMULATION}"]) {
                timeout(GLOBAL_TIMEOUT_MINUTES) {
                    oe.WinCompilePackageTest("build/X64-${build_type}", build_type, has_quote_provider, CTEST_TIMEOUT_SECONDS, lvi_mitigation)
                }
            }
        }
    }
}

win2016CrossCompile('Debug', 'OFF', 'ControlFlow', '1')
win2016CrossCompile('Release', 'OFF', 'ControlFlow', '1') 
win2016CrossCompile('Debug', 'ON', 'ControlFlow')
win2016CrossCompile('Release', 'ON', 'ControlFlow')

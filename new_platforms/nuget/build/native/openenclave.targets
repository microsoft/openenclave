<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <!-- Relative paths to the Open Enclave SDK Libraries within the NuGet Package -->
    <PropertyGroup>
        <SgxHwX86Dbg>$(MSBuildThisFileDirectory)..\..\lib\native\v141\sgx\hw\x86\Debug</SgxHwX86Dbg>
        <SgxHwX64Dbg>$(MSBuildThisFileDirectory)..\..\lib\native\v141\sgx\hw\x64\Debug</SgxHwX64Dbg>

        <SgxSimX86Dbg>$(MSBuildThisFileDirectory)..\..\lib\native\v141\sgx\sim\x86\Debug</SgxSimX86Dbg>
        <SgxSimX64Dbg>$(MSBuildThisFileDirectory)..\..\lib\native\v141\sgx\sim\x64\Debug</SgxSimX64Dbg>

        <TzHwArmDbg>$(MSBuildThisFileDirectory)..\..\lib\native\v141\tz\hw\arm\Debug</TzHwArmDbg>

        <OpteeSimX86Dbg>$(MSBuildThisFileDirectory)..\..\lib\native\v141\tz\sim\x86\Debug</OpteeSimX86Dbg>

        <SgxLibsT>sgx_tstdc.lib;sgx_tprotected_fs.lib;sgx_tcxx.lib;sgx_tstdc.lib;sgx_tcrypto.lib</SgxLibsT>
        <SgxHwLibsT>$(SgxLibsT);sgx_trts.lib;sgx_tservice.lib</SgxHwLibsT>
        <SgxSimLibsT>$(SgxLibsT);sgx_trts_sim.lib;sgx_tservice_sim.lib</SgxSimLibsT>

        <SgxLibsU>sgx_uprotected_fs.lib</SgxLibsU>
        <SgxHwLibsU>$(SgxLibsU);sgx_urts.lib;sgx_uae_service.lib</SgxHwLibsU>
        <SgxSimLibsU>$(SgxLibsU);sgx_urts_sim.lib;sgx_uae_service_sim.lib</SgxSimLibsU>
    </PropertyGroup>

    <!-- Additional Include Directories for Enclaves and Host Applications -->
    <ItemDefinitionGroup>
        <ClCompile>
            <AdditionalIncludeDirectories>
                $(MSBuildThisFileDirectory)include;%(AdditionalIncludeDirectories)
            </AdditionalIncludeDirectories>
        </ClCompile>
    </ItemDefinitionGroup>

    <!-- Preprocessor Definitions for Enclaves Only -->
    <ItemDefinitionGroup Condition="'$(OEType)' == 'Enclave'">
        <ClCompile>
            <!-- SGX Hardware and Simulation --> 
            <PreprocessorDefinitions Condition="'$(Configuration)' == 'SGX-Debug' Or '$(Configuration)' == 'SGX-Simulation-Debug'">
                OE_NO_SAL;%(PreprocessorDefinitions)
            </PreprocessorDefinitions>

            <!-- OP-TEE Simulation --> 
            <PreprocessorDefinitions Condition="'$(Configuration)' == 'OPTEE-Simulation-Debug'">
                OE_SIMULATE_OPTEE;%(PreprocessorDefinitions)
            </PreprocessorDefinitions>
        </ClCompile>
    </ItemDefinitionGroup>

    <!-- Preprocessor Definitions for Hosts Only -->
    <ItemDefinitionGroup Condition="'$(OEType)' != 'Enclave'">
        <ClCompile>
            <!-- OP-TEE Simulation --> 
            <PreprocessorDefinitions Condition="'$(Configuration)' == 'OPTEE-Simulation-Debug'">
                OE_SIMULATE_OPTEE;%(PreprocessorDefinitions)
            </PreprocessorDefinitions>
        </ClCompile>
    </ItemDefinitionGroup>

    <!-- Additional Library Directories for Enclaves and Host Applications -->
    <ItemDefinitionGroup>
        <!-- x86-SGX-Debug & x86-SGX-Simulation-Debug -->
        <AdditionalLibraryDirectories Condition="('$(Configuration)' == 'SGX-Debug' Or '$(Configuration)' == 'SGX-Simulation-Debug') And ('$(Platform)' == 'Win32' Or '$(Platform)' == 'x86')">
            $(SGXSDKInstallPath)\bin\Win32\Debug;%(AdditionalLibraryDirectories)
        </AdditionalLibraryDirectories>

        <!-- x64-SGX-Debug & x64-SGX-Simulation-Debug -->
        <AdditionalLibraryDirectories Condition="('$(Configuration)' == 'SGX-Debug' Or '$(Configuration)' == 'SGX-Simulation-Debug') And '$(Platform)' == 'x64'">
            $(SGXSDKInstallPath)\bin\x64\Debug;%(AdditionalLibraryDirectories)
        </AdditionalLibraryDirectories>
    </ItemDefinitionGroup>

    <!-- Additional Dependencies for Enclaves -->
    <ItemDefinitionGroup Condition="'$(OEType)' == 'Enclave'">
        <Link>
            <!-- All, except OP-TEE Simulation -->
            <IgnoreAllDefaultLibraries Condition="'$(Configuration)' != 'OPTEE-Simulation-Debug'">OpteeSimX86
                true
            </IgnoreAllDefaultLibraries>

            <!-- x86-SGX-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'SGX-Debug' And ('$(Platform)' == 'Win32' Or '$(Platform)' == 'x86')">
                $(SgxHwX86Dbg)\oeenclave.lib;$(SgxHwX86Dbg)\oesocket_enc.lib;$(SgxHwX86Dbg)\oestdio_enc.lib;$(SgxHwLibsT)
            </AdditionalDependencies>

            <!-- x64-SGX-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'SGX-Debug' And '$(Platform)' == 'x64'">
                $(SgxHwX64Dbg)\oeenclave.lib;$(SgxHwX64Dbg)\oesocket_enc.lib;$(SgxHwX64Dbg)\oestdio_enc.lib;$(SgxHwLibsT)
            </AdditionalDependencies>

            <!-- x86-SGX-Simulation-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'SGX-Simulation-Debug' And ('$(Platform)' == 'Win32' Or '$(Platform)' == 'x86')">
                $(SgxSimX86Dbg)\oeenclave.lib;$(SgxSimX86Dbg)\oesocket_enc.lib;$(SgxSimX86Dbg)\oestdio_enc.lib;$(SgxSimLibsT)
            </AdditionalDependencies>

            <!-- x64-SGX-Simulation-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'SGX-Simulation-Debug' And '$(Platform)' == 'x64'">
                $(SgxSimX64Dbg)\oeenclave.lib;$(SgxSimX64Dbg)\oesocket_enc.lib;$(SgxSimX64Dbg)\oestdio_enc.lib;$(SgxSimLibsT)
            </AdditionalDependencies>

            <!-- x86-OPTEE-Simulation-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'OPTEE-Simulation-Debug' And ('$(Platform)' == 'Win32' Or '$(Platform)' == 'x86')">
                $(OpteeSimX86Dbg)\oeenclave.lib;$(OpteeSimX86Dbg)\oesocket_enc.lib;$(OpteeSimX86Dbg)\oestdio_enc.lib;$(OpteeSimX86Dbg)\oeenclave_opteesim.lib;onecore.lib;%(AdditionalDependencies)
            </AdditionalDependencies>
        </Link>
    </ItemDefinitionGroup>

    <!-- Additional Dependencies for Host Applications -->
    <ItemDefinitionGroup Condition="'$(OEType)' != 'Enclave'">
        <Link>
            <!-- x86-SGX-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'SGX-Debug' And ('$(Platform)' == 'Win32' Or '$(Platform)' == 'x86')">
                $(SgxHwX86Dbg)\oehost.lib;$(SgxHwX86Dbg)\oesocket_host.lib;$(SgxHwX86Dbg)\oestdio_host.lib;onecore.lib;%(SgxHwLibsU);%(AdditionalDependencies)
            </AdditionalDependencies>

            <!-- x64-SGX-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'SGX-Debug' And '$(Platform)' == 'x64'">
                $(SgxHwX64Dbg)\oehost.lib;$(SgxHwX64Dbg)\oesocket_host.lib;$(SgxHwX64Dbg)\oestdio_host.lib;onecore.lib;%(SgxHwLibsU);%(AdditionalDependencies)
            </AdditionalDependencies>

            <!-- x86-SGX-Simulation-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'SGX-Simulation-Debug' And ('$(Platform)' == 'Win32' Or '$(Platform)' == 'x86')">
                $(SgxSimX86Dbg)\oehost.lib;$(SgxSimX86Dbg)\oesocket_host.lib;$(SgxSimX86Dbg)\oestdio_host.lib;onecore.lib;%(SgxSimLibsU);%(AdditionalDependencies)
            </AdditionalDependencies>

            <!-- x64-SGX-Simulation-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'SGX-Simulation-Debug' And '$(Platform)' == 'x64'">
                $(SgxSimX64Dbg)\oehost.lib;$(SgxSimX64Dbg)\oesocket_host.lib;$(SgxSimX64Dbg)\oestdio_host.lib;onecore.lib;%(SgxSimLibsU);%(AdditionalDependencies)
            </AdditionalDependencies>

            <!-- arm-TZ-OPTEE-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'TZ-OPTEE-Debug' And '$(Platform)' == 'ARM'">
                $(TzHwArmDbg)\oehost.lib;$(TzHwArmDbg)\oesocket_host.lib;$(TzHwArmDbg)\oestdio_host.lib;onecore.lib;%(AdditionalDependencies)
            </AdditionalDependencies>

            <!-- x86-OPTEE-Simulation-Debug -->
            <AdditionalDependencies Condition="'$(Configuration)' == 'OPTEE-Simulation-Debug' And ('$(Platform)' == 'Win32' Or '$(Platform)' == 'x86')">
                $(OpteeSimX86Dbg)\oehost.lib;$(OpteeSimX86Dbg)\oesocket_host.lib;$(OpteeSimX86Dbg)\oestdio_host.lib;$(OpteeSimX86Dbg)\oehost_opteesim.lib;onecore.lib;%(AdditionalDependencies)
            </AdditionalDependencies>
        </Link>
    </ItemDefinitionGroup>

    <!-- Post-Build Events for Enclaves -->
    <ItemDefinitionGroup Condition="'$(OEType)' == 'Enclave'">
        <!-- x86-SGX-Debug & x86-SGX-Simulation-Debug -->
        <PostBuildEvent Condition="'$(Configuration)' == 'SGX-Debug' Or '$(Configuration)' == 'SGX-Simulation-Debug'">
            <Command>"$(SGXSDKInstallPath)bin\win32\release\sgx_sign.exe" sign -key "$(ProjectDir)$(TargetName)_private.pem" -enclave "$(OutDir)$(TargetFileName)" -out "$(OutDir)$(TargetName).signed.dll" -config "$(ProjectDir)$(TargetName).config.xml"</Command>
            <Message>Sign the enclave for Intel SGX.</Message>
        </PostBuildEvent>
    </ItemDefinitionGroup>
</Project>
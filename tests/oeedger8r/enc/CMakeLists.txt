# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Custom command to copy edl files to binary enc folder
# and run oeedger8r on the edl files.
# Dependency is specified on the edl files in the source tree.
add_custom_command(
    OUTPUT edge_function_implementations

    COMMAND ${OE_BINDIR}/oeedger8r --trusted ${CMAKE_CURRENT_SOURCE_DIR}/../edl/array.edl
    COMMAND ${OE_BINDIR}/oeedger8r --trusted ${CMAKE_CURRENT_SOURCE_DIR}/../edl/basic.edl
    COMMAND ${OE_BINDIR}/oeedger8r --trusted ${CMAKE_CURRENT_SOURCE_DIR}/../edl/enum.edl
    COMMAND ${OE_BINDIR}/oeedger8r --trusted ${CMAKE_CURRENT_SOURCE_DIR}/../edl/foreign.edl
    COMMAND ${OE_BINDIR}/oeedger8r --trusted ${CMAKE_CURRENT_SOURCE_DIR}/../edl/pointer.edl
    COMMAND ${OE_BINDIR}/oeedger8r --trusted ${CMAKE_CURRENT_SOURCE_DIR}/../edl/string.edl
    COMMAND ${OE_BINDIR}/oeedger8r --trusted ${CMAKE_CURRENT_SOURCE_DIR}/../edl/struct.edl

    COMMAND touch edge_function_implementations
    
    # Rerun if any edl file changes or the oeedger8r binary changes.
    DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/../edl/*.edl
    DEPENDS oeedger8r
)
 
# Custom target that depends on edge function implementations
# generated by the above command.
add_custom_target(
    run_oeedger8r_trusted
    DEPENDS edge_function_implementations
)

include(add_enclave_executable)

add_enclave_executable(edl_enc sign.conf private.pem
    testarray.cpp
    testbasic.cpp 
    testenum.cpp 
    testforeign.cpp
    testpointer.cpp
    teststring.cpp
    teststruct.cpp
    )

# Make edl_enc depend on edl files and outputs using 
# the custom target.
add_dependencies(edl_enc run_oeedger8r_trusted) 

target_include_directories(edl_enc PRIVATE ${CMAKE_CURRENT_BINARY_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/..)
target_compile_options(edl_enc PRIVATE -std=c++11)

target_link_libraries(edl_enc oelibcxx oeenclave)
